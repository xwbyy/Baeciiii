<%- include('partials/header') %>

<section class="py-4 sm:py-6 px-3 sm:px-4">
  <div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
      <h1 class="text-lg sm:text-2xl font-bold flex items-center gap-2">
        <i class="fas fa-cog text-purple-400"></i>
        <span>Dashboard Admin</span>
      </h1>
      <a href="/" class="text-gray-400 hover:text-white transition text-xs sm:text-sm">
        <i class="fas fa-home mr-1"></i><span class="hidden sm:inline">Beranda</span>
      </a>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-4 sm:mb-6">
      <div class="stat-card rounded-xl p-3 sm:p-4 bg-purple-900/20 border border-purple-500/20">
        <div class="text-xs text-gray-400 mb-1">System Health</div>
        <div id="system-health-mini" class="text-sm font-medium text-green-400">Loading...</div>
      </div>
      <div class="stat-card rounded-xl p-3 sm:p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg sm:text-xl font-bold"><%= stats.totalUsers || 0 %></div>
            <div class="text-gray-400 text-xs">Users</div>
          </div>
          <i class="fas fa-users text-lg sm:text-xl text-purple-400"></i>
        </div>
      </div>
      <div class="stat-card rounded-xl p-3 sm:p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-lg sm:text-xl font-bold"><%= stats.totalOrders || 0 %></div>
            <div class="text-gray-400 text-xs">Orders</div>
          </div>
          <i class="fas fa-shopping-cart text-lg sm:text-xl text-pink-400"></i>
        </div>
      </div>
      <div class="stat-card rounded-xl p-3 sm:p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm sm:text-lg font-bold">Rp <%= ((stats.totalRevenue || 0) / 1000).toFixed(0) %>K</div>
            <div class="text-gray-400 text-xs">Revenue</div>
          </div>
          <i class="fas fa-chart-line text-lg sm:text-xl text-green-400"></i>
        </div>
      </div>
      <div class="stat-card rounded-xl p-3 sm:p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm sm:text-lg font-bold">Rp <%= ((stats.totalDeposits || 0) / 1000).toFixed(0) %>K</div>
            <div class="text-gray-400 text-xs">Deposits</div>
          </div>
          <i class="fas fa-wallet text-lg sm:text-xl text-orange-400"></i>
        </div>
      </div>
    </div>

    <div class="mb-4 sm:mb-6 overflow-x-auto pb-2 -mx-3 px-3">
      <div class="flex gap-1.5 sm:gap-2 min-w-max">
        <button onclick="showTab('users')" class="tab-btn active px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="users">
          <i class="fas fa-users mr-1 sm:mr-2"></i>Users
        </button>
        <button onclick="showTab('products')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="products">
          <i class="fas fa-box mr-1 sm:mr-2"></i>Produk
        </button>
        <button onclick="showTab('servers')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="servers">
          <i class="fas fa-server mr-1 sm:mr-2"></i>Server
        </button>
        <button onclick="showTab('orders')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="orders">
          <i class="fas fa-shopping-bag mr-1 sm:mr-2"></i>Orders
        </button>
        <button onclick="showTab('transactions')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="transactions">
          <i class="fas fa-receipt mr-1 sm:mr-2"></i>Transaksi
        </button>
        <button onclick="showTab('settings')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="settings">
          <i class="fas fa-cog mr-1 sm:mr-2"></i>Settings
        </button>
        <button onclick="showTab('api')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="api">
          <i class="fas fa-key mr-1 sm:mr-2"></i>API
        </button>
        <button onclick="showTab('vouchers')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="vouchers">
          <i class="fas fa-ticket-alt mr-1 sm:mr-2"></i>Voucher
        </button>
        <button onclick="showTab('broadcast')" class="tab-btn px-3 sm:px-4 py-2 rounded-lg text-xs font-medium whitespace-nowrap" data-tab="broadcast">
          <i class="fas fa-bullhorn mr-1 sm:mr-2"></i>Broadcast
        </button>
      </div>
    </div>

    <div id="usersTab" class="tab-content">
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Daftar Users</h3>
          <span class="text-xs text-gray-400"><%= users.length %> users</span>
        </div>
        <div class="space-y-2">
          <% users.forEach(u => { %>
            <div class="glass rounded-lg p-3">
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-medium text-sm truncate"><%= u.username %></span>
                    <span class="px-1.5 py-0.5 rounded text-[10px] <%= u.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-gray-500/20 text-gray-400' %>">
                      <%= u.role %>
                    </span>
                  </div>
                  <div class="text-xs text-gray-400 truncate"><%= u.email %></div>
                  <div class="text-xs text-gray-500"><%= u.phone || '-' %></div>
                </div>
                <div class="flex items-center justify-between sm:justify-end gap-3">
                  <span class="text-sm font-medium text-green-400">Rp <%= u.balance.toLocaleString('id-ID') %></span>
                  <div class="flex gap-1">
                    <button onclick="openUserModal('<%= u.id %>')" class="w-7 h-7 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center hover:bg-blue-500/30" title="Detail">
                      <i class="fas fa-eye text-xs"></i>
                    </button>
                    <button onclick="openBalanceModal('<%= u.id %>', '<%= u.username %>', <%= u.balance %>)" class="w-7 h-7 rounded-lg bg-green-500/20 text-green-400 flex items-center justify-center hover:bg-green-500/30" title="Edit Saldo">
                      <i class="fas fa-wallet text-xs"></i>
                    </button>
                    <button onclick="openPasswordModal('<%= u.id %>', '<%= u.username %>')" class="w-7 h-7 rounded-lg bg-yellow-500/20 text-yellow-400 flex items-center justify-center hover:bg-yellow-500/30" title="Ganti Password">
                      <i class="fas fa-key text-xs"></i>
                    </button>
                    <% if (u.role !== 'admin') { %>
                      <button onclick="deleteUser('<%= u.id %>')" class="w-7 h-7 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/30" title="Hapus">
                        <i class="fas fa-trash text-xs"></i>
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div id="productsTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5 mb-4">
        <h3 class="font-semibold text-sm mb-3">Tambah Produk Baru</h3>
        <form id="addProductForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-2 sm:gap-3">
            <input type="text" name="name" placeholder="Nama Produk" required class="input-glass rounded-lg py-2 px-3 text-sm col-span-2">
            <input type="number" name="price" placeholder="Harga" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="number" name="stock" placeholder="Stok" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="text" name="category" placeholder="Kategori" class="input-glass rounded-lg py-2 px-3 text-sm col-span-2">
            <textarea name="description" placeholder="Deskripsi" rows="2" class="input-glass rounded-lg py-2 px-3 text-sm col-span-2"></textarea>
            <input type="url" name="downloadLink" placeholder="Link Download (MediaFire, Drive, dll)" class="input-glass rounded-lg py-2 px-3 text-sm col-span-2">
            <div class="col-span-2">
              <label class="block text-xs text-gray-400 mb-1">Gambar (URL atau Upload)</label>
              <input type="text" name="imageUrl" placeholder="https://example.com/image.jpg" class="input-glass rounded-lg py-2 px-3 text-sm w-full mb-2">
              <div class="text-xs text-gray-500 text-center mb-2">atau</div>
              <input type="file" name="image" accept="image/*" class="input-glass rounded-lg py-2 px-3 text-xs w-full">
            </div>
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>Tambah Produk
          </button>
        </form>
      </div>
      
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Daftar Produk</h3>
          <span class="text-xs text-gray-400"><%= products.length %> produk</span>
        </div>
        <div class="space-y-2">
          <% products.forEach(p => { %>
            <div class="glass rounded-lg p-3">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0 overflow-hidden">
                  <% if (p.image) { %>
                    <img src="<%= p.image %>" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-box text-purple-400\'></i>'">
                  <% } else { %>
                    <i class="fas fa-box text-purple-400 text-sm"></i>
                  <% } %>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-sm truncate"><%= p.name %></div>
                  <div class="text-xs text-gray-400">Stok: <%= p.stock %> | <span class="text-purple-400">Rp <%= p.price.toLocaleString('id-ID') %></span></div>
                  <div class="text-xs text-gray-500"><%= p.category || '-' %></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-1">
                  <button onclick="openEditProductModal('<%= p.id %>')" class="w-7 h-7 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center hover:bg-blue-500/30" title="Edit">
                    <i class="fas fa-edit text-xs"></i>
                  </button>
                  <button onclick="toggleProduct('<%= p.id %>', <%= p.isActive %>)" class="w-7 h-7 rounded-lg <%= p.isActive ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400' %> flex items-center justify-center" title="<%= p.isActive ? 'Nonaktifkan' : 'Aktifkan' %>">
                    <i class="fas fa-power-off text-xs"></i>
                  </button>
                  <button onclick="deleteProduct('<%= p.id %>')" class="w-7 h-7 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center" title="Hapus">
                    <i class="fas fa-trash text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          <% }) %>
          <% if (products.length === 0) { %>
            <div class="text-center text-gray-400 py-8 text-sm">Belum ada produk</div>
          <% } %>
        </div>
      </div>
    </div>

    <div id="serversTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5 mb-4">
        <h3 class="font-semibold text-sm mb-3">Tambah Server Baru</h3>
        <form id="addServerForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-2 sm:gap-3">
            <input type="text" name="name" placeholder="Nama Server" required class="input-glass rounded-lg py-2 px-3 text-sm col-span-2">
            <input type="text" name="ram" placeholder="RAM (1GB)" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="text" name="cpu" placeholder="CPU (50%)" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="text" name="disk" placeholder="Disk (5GB)" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="number" name="price" placeholder="Harga/bulan" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="text" name="location" placeholder="Lokasi" class="input-glass rounded-lg py-2 px-3 text-sm col-span-2">
            <textarea name="description" placeholder="Deskripsi" rows="2" class="input-glass rounded-lg py-2 px-3 text-sm col-span-2"></textarea>
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>Tambah Server
          </button>
        </form>
      </div>
      
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Daftar Server</h3>
          <span class="text-xs text-gray-400"><%= servers.length %> server</span>
        </div>
        <div class="space-y-2">
          <% servers.forEach(s => { %>
            <div class="glass rounded-lg p-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-server text-purple-400 text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-sm truncate"><%= s.name %></div>
                  <div class="text-xs text-gray-400"><%= s.ram %> / <%= s.cpu %> / <%= s.disk %></div>
                  <div class="text-xs text-gray-500"><%= s.location || '-' %></div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-purple-400">Rp <%= s.price.toLocaleString('id-ID') %></div>
                  <div class="flex gap-1 justify-end mt-1">
                    <button onclick="openEditServerModal('<%= s.id %>')" class="w-6 h-6 rounded bg-blue-500/20 text-blue-400 flex items-center justify-center" title="Edit">
                      <i class="fas fa-edit text-[10px]"></i>
                    </button>
                    <button onclick="toggleServer('<%= s.id %>', <%= s.isActive %>)" class="w-6 h-6 rounded <%= s.isActive ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400' %> flex items-center justify-center" title="<%= s.isActive ? 'Nonaktifkan' : 'Aktifkan' %>">
                      <i class="fas fa-power-off text-[10px]"></i>
                    </button>
                    <button onclick="deleteServer('<%= s.id %>')" class="w-6 h-6 rounded bg-red-500/20 text-red-400 flex items-center justify-center" title="Hapus">
                      <i class="fas fa-trash text-[10px]"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
          <% if (servers.length === 0) { %>
            <div class="text-center text-gray-400 py-8 text-sm">Belum ada server</div>
          <% } %>
        </div>
      </div>
    </div>

    <div id="ordersTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Daftar Orders</h3>
          <span class="text-xs text-gray-400"><%= orders.length %> orders</span>
        </div>
        <div class="space-y-2">
          <% orders.forEach(o => { %>
            <div class="glass rounded-lg p-3">
              <div class="flex items-start justify-between gap-2 mb-2">
                <div class="min-w-0 flex-1">
                  <div class="font-medium text-sm truncate"><%= o.productName %></div>
                  <div class="text-xs text-gray-400">@<%= o.username %> | <%= o.productType %></div>
                </div>
                <div class="text-right flex-shrink-0">
                  <div class="text-sm font-medium text-green-400">Rp <%= o.totalPrice.toLocaleString('id-ID') %></div>
                  <div class="text-[10px] text-gray-500"><%= new Date(o.createdAt).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' }) %></div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <select onchange="updateOrderStatus('<%= o.id %>', this.value)" class="flex-1 input-glass rounded-lg py-1.5 px-2 text-xs">
                  <option value="pending" <%= o.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="processing" <%= o.status === 'processing' ? 'selected' : '' %>>Processing</option>
                  <option value="completed" <%= o.status === 'completed' ? 'selected' : '' %>>Completed</option>
                  <option value="cancelled" <%= o.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
                <button onclick="deleteOrder('<%= o.id %>')" class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500/30" title="Hapus Order">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            </div>
          <% }) %>
          <% if (orders.length === 0) { %>
            <div class="text-center text-gray-400 py-8 text-sm">Belum ada order</div>
          <% } %>
        </div>
      </div>
    </div>

    <div id="transactionsTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Riwayat Transaksi</h3>
          <span class="text-xs text-gray-400"><%= transactions.length %> transaksi</span>
        </div>
        <div class="space-y-2">
          <% transactions.forEach(t => { %>
            <div class="glass rounded-lg p-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg <%= t.type === 'deposit' ? 'bg-green-500/20' : 'bg-purple-500/20' %> flex items-center justify-center flex-shrink-0">
                  <i class="fas <%= t.type === 'deposit' ? 'fa-arrow-down text-green-400' : 'fa-shopping-cart text-purple-400' %> text-xs"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium truncate"><%= t.description %></div>
                  <div class="text-[10px] text-gray-400"><%= new Date(t.createdAt).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }) %></div>
                  <div class="text-[10px] text-gray-500"><%= t.refId || '-' %></div>
                </div>
                <div class="text-right flex-shrink-0">
                  <div class="text-sm font-medium <%= t.amount > 0 ? 'text-green-400' : 'text-red-400' %>">
                    <%= t.amount > 0 ? '+' : '' %>Rp <%= Math.abs(t.amount).toLocaleString('id-ID') %>
                  </div>
                  <div class="flex items-center gap-1 justify-end mt-1">
                    <select onchange="updateTransactionStatus('<%= t.id %>', this.value)" class="input-glass rounded py-0.5 px-1 text-[10px]">
                      <option value="pending" <%= t.status === 'pending' ? 'selected' : '' %>>Pending</option>
                      <option value="completed" <%= t.status === 'completed' ? 'selected' : '' %>>Completed</option>
                      <option value="cancelled" <%= t.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                    </select>
                    <button onclick="deleteTransaction('<%= t.id %>')" class="w-6 h-6 rounded bg-red-500/20 text-red-400 flex items-center justify-center" title="Hapus">
                      <i class="fas fa-trash text-[10px]"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
          <% if (transactions.length === 0) { %>
            <div class="text-center text-gray-400 py-8 text-sm">Belum ada transaksi</div>
          <% } %>
        </div>
      </div>
    </div>

    <div id="settingsTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <h3 class="font-semibold text-sm mb-3">Pengaturan Website</h3>
        <form id="settingsForm" class="space-y-3">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Nama Website</label>
            <input type="text" name="siteName" value="<%= settings.siteName || 'Baeci Market' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Deskripsi</label>
            <textarea name="siteDescription" rows="2" class="w-full input-glass rounded-lg py-2 px-3 text-sm"><%= settings.siteDescription || '' %></textarea>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">WhatsApp Support</label>
            <input type="text" name="whatsapp" value="<%= settings.whatsapp || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="628xxxxxxx">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Discord Link</label>
            <input type="text" name="discord" value="<%= settings.discord || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-save mr-2"></i>Simpan Pengaturan
          </button>
        </form>
      </div>
    </div>

    <div id="vouchersTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5 mb-4">
        <h3 class="font-semibold text-sm mb-3">Tambah Voucher Baru</h3>
        <form id="addVoucherForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-2 sm:gap-3">
            <input type="text" name="code" placeholder="KODE VOUCHER" required class="input-glass rounded-lg py-2 px-3 text-sm uppercase">
            <select name="discountType" class="input-glass rounded-lg py-2 px-3 text-sm">
              <option value="fixed">Potongan Tetap (Rp)</option>
              <option value="percent">Persentase (%)</option>
            </select>
            <input type="number" name="discountValue" placeholder="Nilai Potongan" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="number" name="minPurchase" placeholder="Minimal Pembelian" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="number" name="maxUsage" placeholder="Maksimal Penggunaan" required class="input-glass rounded-lg py-2 px-3 text-sm">
            <input type="date" name="expiryDate" class="input-glass rounded-lg py-2 px-3 text-sm">
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">Tambah Voucher</button>
        </form>
      </div>
      <div class="glass-card rounded-xl p-3 sm:p-5">
        <h3 class="font-semibold text-sm mb-3">Daftar Voucher</h3>
        <div class="space-y-2">
          <% vouchers.forEach(v => { %>
            <div class="glass rounded-lg p-3 flex justify-between items-center">
              <div>
                <div class="font-bold text-sm"><%= v.code %></div>
                <div class="text-[10px] text-gray-400">
                  Potongan: <%= v.discountType === 'percent' ? v.discountValue + '%' : 'Rp ' + v.discountValue.toLocaleString() %>
                  | Min: Rp <%= v.minPurchase.toLocaleString() %>
                </div>
                <div class="text-[10px] text-gray-500">Terpakai: <%= v.usedCount %> / <%= v.maxUsage %></div>
              </div>
              <button onclick="deleteVoucher('<%= v.id %>')" class="w-7 h-7 rounded-lg bg-red-500/20 text-red-400 flex items-center justify-center">
                <i class="fas fa-trash text-xs"></i>
              </button>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div id="broadcastTab" class="tab-content hidden">
      <div class="glass-card rounded-xl p-3 sm:p-5 mb-4">
        <h3 class="font-semibold text-sm mb-3">Kirim Broadcast</h3>
        <form id="broadcastForm" class="space-y-3">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Target User</label>
            <select name="userId" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              <option value="all">Semua User</option>
              <% users.forEach(u => { %>
                <option value="<%= u.id %>"><%= u.username %> (<%= u.email %>)</option>
              <% }) %>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Tipe Notifikasi</label>
            <select name="type" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              <option value="info">Informasi (Biru)</option>
              <option value="success">Sukses (Hijau)</option>
              <option value="warning">Peringatan (Kuning)</option>
              <option value="danger">Penting (Merah)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Judul</label>
            <input type="text" name="title" required placeholder="Contoh: Maintenance Selesai" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Pesan</label>
            <textarea name="message" required rows="3" placeholder="Isi pesan broadcast..." class="w-full input-glass rounded-lg py-2 px-3 text-sm"></textarea>
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-paper-plane mr-2"></i>Kirim Broadcast
          </button>
        </form>
      </div>
    </div>
    
    <div id="apiTab" class="tab-content hidden">
      <div class="space-y-4">
        <div class="glass-card rounded-xl p-3 sm:p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-sm flex items-center gap-2">
              <i class="fas fa-server text-purple-400"></i>
              Pterodactyl Panel
            </h3>
            <button onclick="testPanelConnection()" id="testPanelBtn" class="px-3 py-1 rounded-lg bg-purple-500/20 text-purple-400 text-xs hover:bg-purple-500/30">
              <i class="fas fa-plug mr-1"></i>Test Koneksi
            </button>
          </div>
          <div id="panelStatus" class="hidden mb-3 p-2 rounded-lg text-xs"></div>
          <form id="panelSettingsForm" class="space-y-3">
            <div>
              <label class="block text-xs text-gray-400 mb-1">Panel URL</label>
              <input type="url" name="domain" value="<%= settings.panel?.domain || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="https://panel.example.com">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">Application API Key (Admin)</label>
              <input type="text" name="apikey" value="<%= settings.panel?.apikey || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm font-mono text-xs" placeholder="ptla_xxxxx">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">Client API Key</label>
              <input type="text" name="capikey" value="<%= settings.panel?.capikey || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm font-mono text-xs" placeholder="ptlc_xxxxx">
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-xs text-gray-400 mb-1">Nest ID</label>
                <input type="text" name="nestid" value="<%= settings.panel?.nestid || '5' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Egg ID</label>
                <input type="text" name="egg" value="<%= settings.panel?.egg || '15' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Location ID</label>
                <input type="text" name="loc" value="<%= settings.panel?.loc || '1' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
            </div>
            <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
              <i class="fas fa-save mr-2"></i>Simpan Konfigurasi Panel
            </button>
          </form>
        </div>

        <div class="glass-card rounded-xl p-3 sm:p-5">
          <h3 class="font-semibold text-sm flex items-center gap-2 mb-3">
            <i class="fas fa-credit-card text-green-400"></i>
            TokoPay Payment Gateway
          </h3>
          <form id="tokopaySettingsForm" class="space-y-3">
            <div>
              <label class="block text-xs text-gray-400 mb-1">Merchant ID</label>
              <input type="text" name="merchant_id" value="<%= settings.tokopay?.merchant_id || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm font-mono" placeholder="M240xxxxxxxxx">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">Secret Key</label>
              <input type="password" name="secret_key" value="<%= settings.tokopay?.secret_key || '' %>" class="w-full input-glass rounded-lg py-2 px-3 text-sm font-mono" placeholder="xxxxxxxxxxxxxxxx">
            </div>
            <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
              <i class="fas fa-save mr-2"></i>Simpan Konfigurasi TokoPay
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" style="background: rgba(0,0,0,0.7);">
  <div class="glass-card rounded-2xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h3 id="modalTitle" class="font-semibold text-lg">Modal</h3>
      <button onclick="closeModal()" class="w-8 h-8 rounded-full glass flex items-center justify-center hover:bg-white/10">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<style>
  .tab-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
  .tab-btn.active { background: linear-gradient(135deg, #9333ea 0%, #c026d3 100%); border-color: transparent; }
</style>

<script>
  // System Health Polling
  function updateHealth() {
    fetch('/admin/system-status')
      .then(res => res.json())
      .then(data => {
        const el = document.getElementById('system-health-mini');
        if (el && data.success) {
          el.innerHTML = `<span class="text-green-400">CPU: ${data.load}%</span><br><span class="text-blue-400">RAM: ${data.mem}%</span>`;
        }
      });
  }
  setInterval(updateHealth, 10000);
  updateHealth();

  function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.remove('hidden');
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  }

  function openModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalContent').innerHTML = content;
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').classList.add('flex');
  }

  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('modal').classList.remove('flex');
  }

  async function apiCall(url, method = 'POST', data = null) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (data) options.body = JSON.stringify(data);
    const res = await fetch(url, options);
    return res.json();
  }

  function openUserModal(userId) {
    apiCall(`/admin/users/${userId}`, 'GET').then(r => {
      if (r.success) {
        const u = r.user;
        openModal('Detail User', `
          <div class="space-y-3">
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Username</div>
              <div class="font-medium">${u.username}</div>
            </div>
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Email</div>
              <div class="font-medium">${u.email}</div>
            </div>
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Phone</div>
              <div class="font-medium">${u.phone || '-'}</div>
            </div>
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Saldo</div>
              <div class="font-medium text-green-400">Rp ${u.balance.toLocaleString('id-ID')}</div>
            </div>
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Role</div>
              <div class="font-medium">${u.role}</div>
            </div>
            <div class="glass rounded-lg p-3">
              <div class="text-xs text-gray-400">Bergabung</div>
              <div class="font-medium">${new Date(u.createdAt).toLocaleDateString('id-ID')}</div>
            </div>
          </div>
        `);
      }
    });
  }

  function openBalanceModal(userId, username, currentBalance) {
    openModal('Edit Saldo - ' + username, `
      <form onsubmit="submitBalance(event, '${userId}')">
        <div class="space-y-3">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Saldo Saat Ini</label>
            <div class="text-lg font-bold text-green-400">Rp ${currentBalance.toLocaleString('id-ID')}</div>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Aksi</label>
            <select name="action" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              <option value="add">Tambah Saldo</option>
              <option value="subtract">Kurangi Saldo</option>
              <option value="set">Set Saldo</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Jumlah</label>
            <input type="number" name="amount" required min="0" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="10000">
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-save mr-2"></i>Simpan
          </button>
        </div>
      </form>
    `);
  }

  async function submitBalance(e, userId) {
    e.preventDefault();
    const form = e.target;
    const action = form.action.value;
    const amount = parseInt(form.amount.value);
    const r = await apiCall(`/admin/users/balance/${userId}`, 'POST', { action, amount });
    alert(r.message);
    if (r.success) location.reload();
  }

  function openPasswordModal(userId, username) {
    openModal('Ganti Password - ' + username, `
      <form onsubmit="submitPassword(event, '${userId}')">
        <div class="space-y-3">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Password Baru</label>
            <input type="password" name="newPassword" required minlength="6" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="Minimal 6 karakter">
          </div>
          <div>
            <label class="block text-xs text-gray-400 mb-1">Konfirmasi Password</label>
            <input type="password" name="confirmPassword" required minlength="6" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="Ulangi password">
          </div>
          <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-key mr-2"></i>Ganti Password
          </button>
        </div>
      </form>
    `);
  }

  async function submitPassword(e, userId) {
    e.preventDefault();
    const form = e.target;
    if (form.newPassword.value !== form.confirmPassword.value) {
      alert('Password tidak cocok!');
      return;
    }
    const r = await apiCall(`/admin/users/password/${userId}`, 'POST', { newPassword: form.newPassword.value });
    alert(r.message);
    if (r.success) closeModal();
  }

  function deleteUser(userId) {
    if (!confirm('Hapus user ini?')) return;
    apiCall(`/admin/users/${userId}`, 'DELETE').then(r => { alert(r.message); if(r.success) location.reload(); });
  }

  function openEditProductModal(productId) {
    apiCall(`/admin/products/${productId}`, 'GET').then(r => {
      if (r.success) {
        const p = r.product;
        openModal('Edit Produk', `
          <form onsubmit="submitEditProduct(event, '${productId}')">
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-gray-400 mb-1">Nama Produk</label>
                <input type="text" name="name" value="${p.name}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Harga</label>
                  <input type="number" name="price" value="${p.price}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Stok</label>
                  <input type="number" name="stock" value="${p.stock}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Kategori</label>
                <input type="text" name="category" value="${p.category || ''}" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Deskripsi</label>
                <textarea name="description" rows="2" class="w-full input-glass rounded-lg py-2 px-3 text-sm">${p.description || ''}</textarea>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Link Download</label>
                <input type="url" name="downloadLink" value="${p.downloadLink || ''}" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="https://mediafire.com/...">
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">URL Gambar</label>
                <input type="text" name="imageUrl" value="${p.image || ''}" class="w-full input-glass rounded-lg py-2 px-3 text-sm" placeholder="https://...">
              </div>
              <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
                <i class="fas fa-save mr-2"></i>Simpan Perubahan
              </button>
            </div>
          </form>
        `);
      }
    });
  }

  async function submitEditProduct(e, productId) {
    e.preventDefault();
    const form = e.target;
    const data = {
      name: form.name.value,
      price: form.price.value,
      stock: form.stock.value,
      category: form.category.value,
      description: form.description.value,
      downloadLink: form.downloadLink.value,
      image: form.imageUrl.value,
      isActive: 'true'
    };
    const r = await apiCall(`/admin/products/update/${productId}`, 'POST', data);
    alert(r.message);
    if (r.success) location.reload();
  }

  function deleteProduct(productId) {
    if (!confirm('Hapus produk ini?')) return;
    apiCall(`/admin/products/${productId}`, 'DELETE').then(r => { alert(r.message); if(r.success) location.reload(); });
  }

  function toggleProduct(productId, isActive) {
    apiCall(`/admin/products/update/${productId}`, 'POST', { isActive: (!isActive).toString() }).then(r => { if(r.success) location.reload(); });
  }

  function openEditServerModal(serverId) {
    apiCall(`/admin/servers/${serverId}`, 'GET').then(r => {
      if (r.success) {
        const s = r.server;
        openModal('Edit Server', `
          <form onsubmit="submitEditServer(event, '${serverId}')">
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-gray-400 mb-1">Nama Server</label>
                <input type="text" name="name" value="${s.name}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
              </div>
              <div class="grid grid-cols-3 gap-2">
                <div>
                  <label class="block text-xs text-gray-400 mb-1">RAM</label>
                  <input type="text" name="ram" value="${s.ram}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">CPU</label>
                  <input type="text" name="cpu" value="${s.cpu}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Disk</label>
                  <input type="text" name="disk" value="${s.disk}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Harga</label>
                  <input type="number" name="price" value="${s.price}" required class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Lokasi</label>
                  <input type="text" name="location" value="${s.location || ''}" class="w-full input-glass rounded-lg py-2 px-3 text-sm">
                </div>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Deskripsi</label>
                <textarea name="description" rows="2" class="w-full input-glass rounded-lg py-2 px-3 text-sm">${s.description || ''}</textarea>
              </div>
              <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-medium">
                <i class="fas fa-save mr-2"></i>Simpan Perubahan
              </button>
            </div>
          </form>
        `);
      }
    });
  }

  async function submitEditServer(e, serverId) {
    e.preventDefault();
    const form = e.target;
    const data = {
      name: form.name.value,
      ram: form.ram.value,
      cpu: form.cpu.value,
      disk: form.disk.value,
      price: form.price.value,
      location: form.location.value,
      description: form.description.value,
      isActive: 'true'
    };
    const r = await apiCall(`/admin/servers/update/${serverId}`, 'POST', data);
    alert(r.message);
    if (r.success) location.reload();
  }

  function deleteServer(serverId) {
    if (!confirm('Hapus server ini?')) return;
    apiCall(`/admin/servers/${serverId}`, 'DELETE').then(r => { alert(r.message); if(r.success) location.reload(); });
  }

  function toggleServer(serverId, isActive) {
    apiCall(`/admin/servers/update/${serverId}`, 'POST', { isActive: (!isActive).toString() }).then(r => { if(r.success) location.reload(); });
  }

  function updateOrderStatus(orderId, status) {
    apiCall(`/admin/orders/status/${orderId}`, 'POST', { status }).then(r => {
      if (!r.success) alert(r.message);
    });
  }

  function deleteOrder(orderId) {
    if (!confirm('Hapus order ini?')) return;
    apiCall(`/admin/orders/${orderId}`, 'DELETE').then(r => { alert(r.message); if(r.success) location.reload(); });
  }

  function updateTransactionStatus(transactionId, status) {
    apiCall(`/admin/transactions/status/${transactionId}`, 'POST', { status }).then(r => {
      if (!r.success) alert(r.message);
    });
  }

  function deleteTransaction(transactionId) {
    if (!confirm('Hapus transaksi ini?')) return;
    apiCall(`/admin/transactions/${transactionId}`, 'DELETE').then(r => { alert(r.message); if(r.success) location.reload(); });
  }

  const addVoucherForm = document.getElementById('addVoucherForm');
  addVoucherForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(addVoucherForm);
    const data = Object.fromEntries(formData.entries());
    const r = await apiCall('/admin/vouchers/add', 'POST', data);
    alert(r.message);
    if (r.success) location.reload();
  });

  async function deleteVoucher(id) {
    if (!confirm('Hapus voucher ini?')) return;
    const r = await apiCall(`/admin/vouchers/${id}`, 'DELETE');
    alert(r.message);
    if (r.success) location.reload();
  }

  document.getElementById('addProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const imageUrl = form.imageUrl?.value?.trim();
    const fileInput = form.image;
    
    if (imageUrl) {
      const data = {
        name: form.name.value,
        price: form.price.value,
        stock: form.stock.value,
        category: form.category.value,
        description: form.description.value,
        downloadLink: form.downloadLink.value,
        image: imageUrl
      };
      const r = await apiCall('/admin/products/add-json', 'POST', data);
      alert(r.message);
      if (r.success) location.reload();
    } else {
      const formData = new FormData(form);
      formData.delete('imageUrl');
      const res = await fetch('/admin/products/add', { method: 'POST', body: formData });
      const r = await res.json();
      alert(r.message);
      if (r.success) location.reload();
    }
  });

  document.getElementById('addServerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await apiCall('/admin/servers/add', 'POST', data);
    alert(r.message);
    if (r.success) location.reload();
  });

  document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await apiCall('/admin/settings', 'POST', data);
    alert(r.message);
  });

  document.getElementById('panelSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await apiCall('/admin/api/panel', 'POST', data);
    alert(r.message);
  });

  document.getElementById('tokopaySettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    const r = await apiCall('/admin/api/tokopay', 'POST', data);
    alert(r.message);
  });

  async function testPanelConnection() {
    const btn = document.getElementById('testPanelBtn');
    const status = document.getElementById('panelStatus');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Testing...';
    
    try {
      const r = await apiCall('/admin/api/panel/test', 'GET');
      status.classList.remove('hidden');
      if (r.success) {
        status.className = 'mb-3 p-2 rounded-lg text-xs bg-green-500/20 text-green-400';
        status.innerHTML = '<i class="fas fa-check-circle mr-1"></i>' + r.message + (r.totalUsers ? ' (' + r.totalUsers + ' users)' : '');
      } else {
        status.className = 'mb-3 p-2 rounded-lg text-xs bg-red-500/20 text-red-400';
        status.innerHTML = '<i class="fas fa-times-circle mr-1"></i>' + r.message;
      }
    } catch (e) {
      status.classList.remove('hidden');
      status.className = 'mb-3 p-2 rounded-lg text-xs bg-red-500/20 text-red-400';
      status.innerHTML = '<i class="fas fa-times-circle mr-1"></i>Gagal test koneksi';
    }
    
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-plug mr-1"></i>Test Koneksi';
  }

    // Broadcast Form
    const broadcastForm = document.getElementById('broadcastForm');
    if (broadcastForm) {
      broadcastForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(broadcastForm);
        const data = Object.fromEntries(formData.entries());
        
        try {
          const res = await fetch('/admin/broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          const result = await res.json();
          alert(result.message);
          if (result.success) broadcastForm.reset();
        } catch (err) {
          alert('Gagal mengirim broadcast');
        }
      });
    }

  document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') closeModal();
  });
</script>

<%- include('partials/footer') %>
