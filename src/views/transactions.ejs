<%- include('partials/header') %>

<section class="py-6 sm:py-10 px-3 sm:px-4">
  <div class="max-w-2xl mx-auto relative">
    <div class="absolute top-10 left-0 w-40 sm:w-64 h-40 sm:h-64 bg-purple-500/10 rounded-full blur-3xl"></div>
    
    <div class="relative z-10 fade-in">
      <div class="flex items-center justify-between mb-5">
        <h1 class="text-lg sm:text-xl font-bold flex items-center gap-2">
          <i class="fas fa-receipt text-purple-400"></i>
          Riwayat Transaksi
        </h1>
        <a href="/profile" class="text-gray-400 hover:text-white transition text-xs sm:text-sm">
          <i class="fas fa-arrow-left mr-1"></i>Kembali
        </a>
      </div>
      
      <% if (transactions && transactions.length > 0) { %>
        <div class="space-y-3">
          <% transactions.forEach((trx, index) => { %>
            <div class="glass-card rounded-xl p-3 sm:p-4 fade-in <%= trx.status === 'pending' && trx.type === 'deposit' ? 'cursor-pointer hover:bg-white/5 transition' : '' %>" 
                 style="animation-delay: <%= index * 0.03 %>s"
                 <% if (trx.status === 'pending' && trx.type === 'deposit' && trx.refId) { %>
                   onclick="recheckPayment('<%= trx.refId %>', this)"
                 <% } %>>
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-10 h-10 sm:w-11 sm:h-11 rounded-lg <%= trx.type === 'deposit' ? 'bg-green-500/20' : 'bg-red-500/20' %> flex items-center justify-center flex-shrink-0">
                    <i class="fas <%= trx.type === 'deposit' ? 'fa-arrow-down text-green-400' : 'fa-arrow-up text-red-400' %> text-sm sm:text-base"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-xs sm:text-sm truncate"><%= trx.description %></div>
                    <div class="text-[10px] sm:text-xs text-gray-500">
                      <%= new Date(trx.createdAt).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }) %>
                    </div>
                    <% if (trx.status === 'pending' && trx.type === 'deposit') { %>
                      <div class="text-[10px] text-purple-400 mt-0.5">
                        <i class="fas fa-hand-pointer mr-1"></i>Tap untuk cek ulang
                      </div>
                    <% } %>
                  </div>
                </div>
                <div class="text-right flex-shrink-0">
                  <div class="font-bold text-sm sm:text-base <%= trx.amount > 0 ? 'text-green-400' : 'text-red-400' %>">
                    <%= trx.amount > 0 ? '+' : '' %>Rp <%= Math.abs(trx.amount).toLocaleString('id-ID') %>
                  </div>
                  <span class="text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full <%= trx.status === 'completed' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400' %>">
                    <%= trx.status === 'completed' ? 'Selesai' : 'Pending' %>
                  </span>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="glass-card rounded-xl p-8 text-center">
          <i class="fas fa-receipt text-4xl text-gray-600 mb-3"></i>
          <h3 class="text-base font-semibold mb-1">Belum Ada Transaksi</h3>
          <p class="text-gray-400 text-xs">Mulai deposit atau beli produk untuk melihat riwayat.</p>
        </div>
      <% } %>
    </div>
  </div>
</section>

<div id="recheckModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="glass-card rounded-xl p-5 max-w-sm w-full text-center">
    <div id="modalLoading">
      <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mx-auto mb-3">
        <i class="fas fa-sync fa-spin text-xl text-purple-400"></i>
      </div>
      <h3 class="font-bold text-base mb-1">Mengecek Pembayaran...</h3>
      <p class="text-gray-400 text-xs">Sedang menghubungi server pembayaran</p>
    </div>
    <div id="modalResult" class="hidden">
      <div id="resultIcon" class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3"></div>
      <h3 id="resultTitle" class="font-bold text-base mb-1"></h3>
      <p id="resultDesc" class="text-gray-400 text-xs mb-4"></p>
      <button onclick="closeModal()" class="btn-primary px-6 py-2 rounded-lg text-sm font-medium">OK</button>
    </div>
  </div>
</div>

<script>
  async function recheckPayment(refId, element) {
    const modal = document.getElementById('recheckModal');
    const loading = document.getElementById('modalLoading');
    const result = document.getElementById('modalResult');
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    loading.classList.remove('hidden');
    result.classList.add('hidden');
    
    try {
      const response = await fetch('/deposit/check/' + refId);
      const data = await response.json();
      
      console.log('Check response:', data);
      
      loading.classList.add('hidden');
      result.classList.remove('hidden');
      
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');
      const desc = document.getElementById('resultDesc');
      
      if (data.status === 'Paid') {
        icon.className = 'w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center mx-auto mb-3';
        icon.innerHTML = '<i class="fas fa-check text-xl text-green-400"></i>';
        title.textContent = 'Pembayaran Berhasil!';
        title.className = 'font-bold text-base mb-1 text-green-400';
        desc.textContent = 'Saldo Anda telah bertambah Rp ' + (data.newBalance || 0).toLocaleString('id-ID');
        
        setTimeout(() => window.location.reload(), 1500);
      } else {
        icon.className = 'w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center mx-auto mb-3';
        icon.innerHTML = '<i class="fas fa-clock text-xl text-yellow-400"></i>';
        title.textContent = 'Menunggu Konfirmasi';
        title.className = 'font-bold text-base mb-1 text-yellow-400';
        desc.textContent = 'Pembayaran sedang diproses payment gateway. Tunggu 1-5 menit atau cek ulang.';
      }
    } catch (error) {
      console.error('Recheck error:', error);
      loading.classList.add('hidden');
      result.classList.remove('hidden');
      
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');
      const desc = document.getElementById('resultDesc');
      
      icon.className = 'w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center mx-auto mb-3';
      icon.innerHTML = '<i class="fas fa-times text-xl text-red-400"></i>';
      title.textContent = 'Gagal Mengecek';
      title.className = 'font-bold text-base mb-1 text-red-400';
      desc.textContent = 'Terjadi kesalahan, coba lagi nanti';
    }
  }
  
  function closeModal() {
    document.getElementById('recheckModal').classList.add('hidden');
    document.getElementById('recheckModal').classList.remove('flex');
  }
  
  document.getElementById('recheckModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });
</script>

<%- include('partials/footer') %>
